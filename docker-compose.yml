services:
  flexerr:
    build: .
    container_name: flexerr
    restart: unless-stopped
    ports:
      - "3100:3100"
    volumes:
      - flexerr-data:/app/data
      # Optional: Mount your media folder for direct file operations
      # - /path/to/your/media:/media
    environment:
      - TZ=${TZ:-UTC}
      - PORT=3100
      - NODE_ENV=production
      # Optional: Set a fixed JWT secret (auto-generated if not set)
      # - JWT_SECRET=your-secret-here
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3100/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # ============================================
    # GPU ACCESS FOR HARDWARE-ACCELERATED ENCODING
    # ============================================
    # Uncomment ONE of the following GPU configurations:

    # --- NVIDIA GPU (RTX/GTX cards with NVENC) ---
    # Requires: NVIDIA Container Toolkit installed on host
    # Install: https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html
    # runtime: nvidia
    # environment:
    #   - NVIDIA_VISIBLE_DEVICES=all
    #   - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility

    # --- AMD/Intel GPU (VAAPI) ---
    # devices:
    #   - /dev/dri:/dev/dri
    # group_add:
    #   - "44"   # video group
    #   - "107"  # render group (may vary by system, check: getent group render)

volumes:
  flexerr-data:
    name: flexerr-data
